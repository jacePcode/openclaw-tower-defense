<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Tower Defense</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#1a1a2e;color:#fff;font-family:sans-serif;display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:10px}
h1{color:#00adb5;margin:10px 0;font-size:1.5em}
#ui{display:flex;gap:15px;flex-wrap:wrap;justify-content:center;margin:8px 0;font-size:14px}
#ui span{background:rgba(0,0,0,.4);padding:6px 12px;border-radius:8px}
#towers{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap;justify-content:center}
.tbtn{padding:8px 14px;border:2px solid #00adb5;background:rgba(0,0,0,.5);color:#fff;border-radius:8px;cursor:pointer;font-size:13px}
.tbtn:hover,.tbtn.active{background:#00adb5;color:#000}
canvas{border:2px solid #00adb5;border-radius:8px;background:#111827;max-width:100%;touch-action:none}
#msg{margin:8px 0;color:#ff9800;font-size:14px;min-height:20px}
</style>
</head>
<body>
<h1>üè∞ Tower Defense</h1>
<div id="ui">
  <span>üí∞ <b id="money">200</b></span>
  <span>‚ù§Ô∏è <b id="lives">20</b></span>
  <span>üåä Wave <b id="wave">1</b>/<b id="totalw">6</b></span>
  <span>üèÜ <b id="score">0</b></span>
</div>
<div id="towers">
  <button class="tbtn" onclick="selectTower('basic')">üîµ Basic $50</button>
  <button class="tbtn" onclick="selectTower('sniper')">üü¢ Sniper $100</button>
  <button class="tbtn" onclick="selectTower('rapid')">üü† Rapid $75</button>
  <button class="tbtn" onclick="selectTower('splash')">üü£ Splash $120</button>
</div>
<div id="msg">Tap a tower button, then tap the grid to place it.</div>
<canvas id="c" width="800" height="480"></canvas>

<script>
const C=document.getElementById('c'),X=C.getContext('2d');
const W=800,H=480,G=40,GW=W/G,GH=H/G;

// Path definition (grid coords)
const PATH=[];
(function(){
  const sy=Math.floor(GH/2);
  for(let x=0;x<=Math.floor(GW/3);x++) PATH.push([x,sy]);
  const ex=Math.floor(GW/3);
  for(let y=sy+1;y<=sy+Math.floor(GH/3);y++) PATH.push([ex,y]);
  const ey=sy+Math.floor(GH/3);
  for(let x=ex+1;x<GW;x++) PATH.push([x,ey]);
})();
const pathSet=new Set(PATH.map(p=>p[0]+','+p[1]));

const TTYPES={
  basic:{cost:50,dmg:10,range:120,rate:1,color:'#4488ff',name:'Basic'},
  sniper:{cost:100,dmg:30,range:200,rate:.5,color:'#44cc44',name:'Sniper'},
  rapid:{cost:75,dmg:5,range:90,rate:3,color:'#ff8800',name:'Rapid'},
  splash:{cost:120,dmg:15,range:100,rate:1.2,color:'#aa44ff',name:'Splash'}
};
const ETYPES={
  basic:{hp:50,spd:1.2,reward:10,color:'#ff4444',r:8},
  fast:{hp:30,spd:2.5,reward:15,color:'#ffff44',r:6},
  tank:{hp:150,spd:.6,reward:30,color:'#aa6633',r:11},
  boss:{hp:400,spd:.4,reward:100,color:'#cc0000',r:14}
};
const WAVES=[
  ['basic','basic','basic','basic','basic'],
  ['basic','fast','basic','fast','basic'],
  ['basic','basic','tank','basic','fast'],
  ['fast','fast','fast','tank','tank'],
  ['tank','tank','basic','basic','fast','fast','fast'],
  ['boss','tank','fast','fast','basic','basic']
];

let money=200,lives=20,score=0,towers=[],enemies=[],projectiles=[];
let waveIdx=0,spawnQueue=[],spawnTimer=0,waveCooldown=3;
let placing=null,gameOver=false,gameWon=false;
let grid=Array.from({length:GH},()=>Array(GW).fill(0));
// Mark path
PATH.forEach(([x,y])=>{if(y>=0&&y<GH&&x>=0&&x<GW) grid[y][x]=1;});

function msg(t){document.getElementById('msg').textContent=t}
function updUI(){
  document.getElementById('money').textContent=money;
  document.getElementById('lives').textContent=lives;
  document.getElementById('wave').textContent=Math.min(waveIdx+1,WAVES.length);
  document.getElementById('totalw').textContent=WAVES.length;
  document.getElementById('score').textContent=score;
}

function selectTower(t){
  placing=t;
  document.querySelectorAll('.tbtn').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
  msg('Tap on the grid to place '+TTYPES[t].name+' ($'+TTYPES[t].cost+')');
}

function pixPath(){return PATH.map(([x,y])=>({x:x*G+G/2,y:y*G+G/2}));}

C.addEventListener('click',e=>{
  if(gameOver||gameWon) return;
  const r=C.getBoundingClientRect();
  const sx=(e.clientX-r.left)*(W/r.width);
  const sy=(e.clientY-r.top)*(H/r.height);
  const gx=Math.floor(sx/G),gy=Math.floor(sy/G);
  if(gx<0||gx>=GW||gy<0||gy>=GH) return;

  if(placing){
    if(grid[gy][gx]!==0){msg('Can\'t place there!');return;}
    const tt=TTYPES[placing];
    if(money<tt.cost){msg('Not enough money!');return;}
    money-=tt.cost;
    towers.push({x:gx*G+G/2,y:gy*G+G/2,type:placing,dmg:tt.dmg,range:tt.range,rate:tt.rate,color:tt.color,cd:0,lvl:1});
    grid[gy][gx]=2;
    placing=null;
    document.querySelectorAll('.tbtn').forEach(b=>b.classList.remove('active'));
    msg('Tower placed! Tap another to place more.');
    updUI();
  } else {
    // Try upgrade
    for(let t of towers){
      if(Math.abs(t.x-(gx*G+G/2))<G/2&&Math.abs(t.y-(gy*G+G/2))<G/2){
        const cost=t.lvl*40+30;
        if(money>=cost){
          money-=cost;t.lvl++;t.dmg=Math.floor(t.dmg*1.4);t.range+=8;t.rate*=1.08;
          msg(TTYPES[t.type].name+' upgraded to Lv'+t.lvl+' ($'+cost+')');
          updUI();
        } else msg('Need $'+cost+' to upgrade');
        return;
      }
    }
  }
});

function spawnWave(){
  if(waveIdx>=WAVES.length){
    if(enemies.length===0){gameWon=true;msg('üéâ You Win! Score: '+score);}
    return;
  }
  spawnQueue=WAVES[waveIdx].slice();
  waveIdx++;spawnTimer=0;
  updUI();
  msg('Wave '+waveIdx+' incoming!');
}

let lastT=0;
function loop(t){
  const dt=Math.min((t-lastT)/1000,.05);lastT=t;
  if(!gameOver&&!gameWon) update(dt);
  draw();
  requestAnimationFrame(loop);
}

function update(dt){
  // Auto-start waves
  if(spawnQueue.length===0&&enemies.length===0){
    waveCooldown-=dt;
    if(waveCooldown<=0){spawnWave();waveCooldown=5;}
  }
  // Spawn
  if(spawnQueue.length>0){
    spawnTimer-=dt;
    if(spawnTimer<=0){
      const et=spawnQueue.shift();
      const e=ETYPES[et];
      const pp=pixPath();
      enemies.push({hp:e.hp,maxHp:e.hp,spd:e.spd,reward:e.reward,color:e.color,r:e.r,path:pp,pi:0,x:pp[0].x,y:pp[0].y});
      spawnTimer=.8;
    }
  }
  // Move enemies
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    if(e.pi>=e.path.length-1){
      lives--;enemies.splice(i,1);
      if(lives<=0){gameOver=true;msg('üíÄ Game Over! Score: '+score);}
      updUI();continue;
    }
    const tgt=e.path[e.pi+1];
    const dx=tgt.x-e.x,dy=tgt.y-e.y,d=Math.sqrt(dx*dx+dy*dy);
    if(d<2){e.pi++;}
    else{const s=e.spd*G*dt;e.x+=dx/d*s;e.y+=dy/d*s;}
    if(e.hp<=0){money+=e.reward;score+=e.reward;enemies.splice(i,1);updUI();}
  }
  // Tower fire
  for(let t of towers){
    t.cd-=dt;
    if(t.cd>0) continue;
    let best=null,bd=Infinity;
    for(let e of enemies){
      const d=Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2);
      if(d<=t.range&&d<bd){bd=d;best=e;}
    }
    if(best){
      projectiles.push({x:t.x,y:t.y,tx:best,dmg:t.dmg,color:t.color,spd:400});
      t.cd=1/t.rate;
    }
  }
  // Projectiles
  for(let i=projectiles.length-1;i>=0;i--){
    const p=projectiles[i];
    if(!p.tx||p.tx.hp<=0){projectiles.splice(i,1);continue;}
    const dx=p.tx.x-p.x,dy=p.tx.y-p.y,d=Math.sqrt(dx*dx+dy*dy);
    if(d<6){p.tx.hp-=p.dmg;projectiles.splice(i,1);}
    else{const s=p.spd*dt;p.x+=dx/d*s;p.y+=dy/d*s;}
  }
}

function draw(){
  X.clearRect(0,0,W,H);
  // Grid
  for(let y=0;y<GH;y++) for(let x=0;x<GW;x++){
    if(pathSet.has(x+','+y)){X.fillStyle='#2a2a3e';X.fillRect(x*G,y*G,G,G);}
    X.strokeStyle='#222';X.strokeRect(x*G,y*G,G,G);
  }
  // Path line
  X.strokeStyle='#444';X.lineWidth=2;X.beginPath();
  PATH.forEach(([x,y],i)=>{const px=x*G+G/2,py=y*G+G/2;i?X.lineTo(px,py):X.moveTo(px,py);});
  X.stroke();X.lineWidth=1;
  // Towers
  for(let t of towers){
    X.fillStyle=t.color;X.beginPath();X.arc(t.x,t.y,G/2-3,0,Math.PI*2);X.fill();
    X.fillStyle='#fff';X.font='bold 11px sans-serif';X.textAlign='center';
    X.fillText('Lv'+t.lvl,t.x,t.y+4);
  }
  // Enemies
  for(let e of enemies){
    X.fillStyle=e.color;X.beginPath();X.arc(e.x,e.y,e.r,0,Math.PI*2);X.fill();
    const bw=24;X.fillStyle='#600';X.fillRect(e.x-bw/2,e.y-e.r-6,bw,3);
    X.fillStyle='#0f0';X.fillRect(e.x-bw/2,e.y-e.r-6,bw*(e.hp/e.maxHp),3);
  }
  // Projectiles
  for(let p of projectiles){
    X.fillStyle=p.color;X.beginPath();X.arc(p.x,p.y,3,0,Math.PI*2);X.fill();
  }
  // Overlay
  if(gameOver||gameWon){
    X.fillStyle='rgba(0,0,0,.7)';X.fillRect(0,0,W,H);
    X.fillStyle='#fff';X.font='bold 36px sans-serif';X.textAlign='center';
    X.fillText(gameWon?'üéâ You Win!':'üíÄ Game Over',W/2,H/2-20);
    X.font='20px sans-serif';X.fillText('Score: '+score,W/2,H/2+20);
  }
}

updUI();
requestAnimationFrame(loop);
</script>
</body>
</html>
